<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICHE CMS - Content Management System for Audio Tours</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1B3A2E 0%, #0F1419 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            color: white;
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.15);
        }

        .nav-tab.active {
            background: #FFD700;
            color: #1B3A2E;
            border-color: #FFD700;
        }

        /* Main Content */
        .main-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
            min-height: 70vh;
        }

        /* Debug Panel */
        .debug-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .debug-panel h4 {
            color: #FFD700;
            margin-bottom: 10px;
        }

        .debug-status {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.green {
            background: #4CAF50;
        }

        .status-dot.red {
            background: #ff6b6b;
        }

        .status-dot.yellow {
            background: #FFC107;
        }

        /* Routes Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn-primary {
            background: #FFD700;
            color: #1B3A2E;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #FFC700;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Route Card */
        .route-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .route-card:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .route-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .route-name:hover {
            color: #FFD700;
        }

        .route-tags {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
        }

        .tag {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag.historical {
            background: rgba(156, 39, 176, 0.2);
            color: #E91E63;
        }

        .tag.modern {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        .tag.published {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .tag.draft {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }

        .route-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .route-stats {
            display: flex;
            gap: 30px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-value {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .route-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-delete {
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
        }

        .btn-delete:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        /* Toggle Switch Styles */
        .publish-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }

        .publish-toggle-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border: 1px solid rgba(255, 107, 107, 0.5);
        }

        .toggle-switch.active {
            background-color: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background-color: #ff6b6b;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
            background-color: #4CAF50;
        }

        .toggle-status {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            min-width: 45px;
            text-align: center;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
        }

        .form-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* City Selection Styles */
        .city-selector-container {
            position: relative;
        }

        .city-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .city-dropdown-container {
            flex: 1;
        }

        .add-city-container {
            display: none;
            flex: 1;
        }

        .city-toggle-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .city-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .city-help-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        /* File Upload Areas */
        .file-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .file-upload-area:hover {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.05);
        }

        .file-upload-area.has-file {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }

        .file-upload-area.uploading {
            border-color: #FFC107;
            background: rgba(255, 193, 7, 0.05);
        }

        .upload-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .upload-subtext {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            padding: 40px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #1B3A2E 0%, #0F1419 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 30px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
        }

        /* Route Image Preview */
        .route-image-preview {
            width: 100%;
            height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .route-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .route-image-placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }

        /* Image Position Preview */
        .image-position-preview {
            margin-top: 15px;
        }

        .position-preview-box {
            width: 100%;
            height: 80px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            font-size: 20px;
        }

        /* Map Styles */
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 10px;
            overflow: hidden;
        }

        .map-container .leaflet-container {
            background: rgba(255, 255, 255, 0.1);
        }

        .location-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .radius-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radius-slider {
            width: 120px;
            appearance: none;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .radius-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
        }

        .radius-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #FFD700;
            cursor: pointer;
            border: none;
        }

        .coordinates-display {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Route Overview Map */
        .route-overview-map {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 15px;
            overflow: hidden;
        }

        /* Loading */
        .loading {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 40px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .route-stats {
                flex-wrap: wrap;
                gap: 20px;
            }

            .route-actions {
                flex-wrap: wrap;
            }

            .publish-toggle-container {
                margin-bottom: 10px;
            }

            .location-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .city-input-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stop-item {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stop-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .stop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stop-name {
            font-weight: 600;
            color: white;
            font-size: 14px;
        }

        .stop-details {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            margin-top: 4px;
        }

        .stop-delete-btn {
            background: rgba(255,107,107,0.2);
            border: none;
            color: #ff6b6b;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .stop-delete-btn:hover {
            background: rgba(255,107,107,0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <div class="logo">ICHE CMS</div>
                <div class="subtitle">Enhanced Content Management System for Audio Tours</div>
            </div>
            <button class="close-btn" onclick="closeCMS()">Close CMS</button>
        </div>

        <!-- Debug Panel -->
        <div class="debug-panel">
            <h4>System Status</h4>
            <div class="debug-status">
                <div class="status-item">
                    <div class="status-dot" id="server-status"></div>
                    <span id="server-status-text">Checking server...</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="routes-status"></div>
                    <span id="routes-status-text">Loading routes...</span>
                </div>
                <div class="status-item">
                    <button class="btn-secondary" onclick="testConnection()">Test Connection</button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <a href="#" class="nav-tab active" data-tab="routes">Routes</a>
            <a href="#" class="nav-tab" data-tab="analytics">Analytics</a>
            <a href="#" class="nav-tab" data-tab="settings">Settings</a>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Routes Tab -->
            <div id="routes-tab" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">Tour Routes</h2>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="testConnection()">Test Connection</button>
                        <button class="btn-primary" onclick="regenerateRoutesFile()">Update App</button>
                        <button class="btn-primary" onclick="createNewRoute()">+ Create New Route</button>
                    </div>
                </div>
                <div id="error-container"></div>
                <div id="routes-list">
                    <div class="loading">Loading routes...</div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Analytics</h2>
                </div>
                <div id="analytics-content">
                    <div class="loading">Loading analytics...</div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Settings</h2>
                </div>
                <div class="form-section">
                    <h3>Debug Tools</h3>
                    <div class="form-group">
                        <button class="btn-secondary" onclick="resetDatabase()">Reset Database</button>
                        <button class="btn-secondary" onclick="importDefaultRoutes()">Import Default Routes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Route Modal -->
    <div id="route-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">New Route</h3>
                <button class="close-btn" onclick="closeModal('route-modal')">Ã—</button>
            </div>
            <form id="route-form" class="form-grid">
                <div class="form-section">
                    <h3>Route Details</h3>
                    <div class="form-group">
                        <label class="form-label">Route Name *</label>
                        <input type="text" class="form-input" name="name" placeholder="Enter route name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <div class="city-selector-container">
                            <div class="city-input-group">
                                <div class="city-dropdown-container" id="cityDropdownContainer">
                                    <select class="form-select" name="city" id="cityDropdown" required>
                                        <option value="">Loading cities...</option>
                                    </select>
                                </div>
                                <div class="add-city-container" id="addCityContainer">
                                    <input type="text" class="form-input" id="newCityInput" placeholder="Enter new city name">
                                </div>
                                <button type="button" class="city-toggle-btn" id="cityToggleBtn" onclick="toggleCityInput()">+ Add New</button>
                            </div>
                            <div class="city-help-text">Select an existing city or add a new one</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" name="category">
                            <option value="Historical">Historical</option>
                            <option value="Modern">Modern</option>
                            <option value="Cultural">Cultural</option>
                            <option value="Nature">Nature</option>
                            <option value="Art">Art</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Difficulty</label>
                        <select class="form-select" name="difficulty">
                            <option value="Easy">Easy</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-input" name="estimatedDuration" placeholder="e.g. 45 minutes">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Distance</label>
                        <input type="text" class="form-input" name="distance" placeholder="e.g. 2.5 km">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" name="description" placeholder="Enter route description"></textarea>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Tour Information</h3>
                    <div class="form-group">
                        <label class="form-label">Route Color</label>
                        <input type="color" class="form-input" name="color" value="#FFD700">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Route Image</label>
                        <input type="url" class="form-input" name="imageUrl" placeholder="Enter image URL or upload below">
                        <div class="file-upload-area" id="route-image-upload" onclick="document.getElementById('route-image-file').click()">
                            <div class="upload-icon">ðŸ“·</div>
                            <div class="upload-text">Click to upload route image</div>
                            <div class="upload-subtext">JPG, PNG up to 10MB</div>
                        </div>
                        <input type="file" id="route-image-file" accept="image/*" style="display: none;" onchange="handleRouteImageUpload(event)">
                        <div class="route-image-preview" id="route-image-preview">
                            <div class="route-image-placeholder">No image selected</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image Position</label>
                        <select class="form-select" name="imagePosition">
                            <option value="center">Center</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="top left">Top Left</option>
                            <option value="top right">Top Right</option>
                            <option value="bottom left">Bottom Left</option>
                            <option value="bottom right">Bottom Right</option>
                        </select>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 5px;">
                            Choose which part of the image to display in route cards
                        </div>
                    </div>
                    <div class="image-position-preview" id="imagePositionPreview" style="display: none;">
                        <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-bottom: 8px;">Preview:</div>
                        <div class="position-preview-box" id="positionPreviewBox">Audio Tour</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Points Added</label>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span id="stops-count-display">0 stops</span>
                            <button type="button" class="btn-primary" onclick="addNewStop()" style="padding: 8px 16px; font-size: 12px;">+ Add Stop</button>
                        </div>
                        <div id="stops-list-inline" style="max-height: 300px; overflow-y: auto;"></div>
                        
                        <div id="route-overview-container" style="display: none; margin-top: 20px;">
                            <h4 style="color: rgba(255,255,255,0.9); margin-bottom: 10px;">Route Overview</h4>
                            <div class="route-overview-map" id="routeOverviewMap"></div>
                        </div>
                    </div>
                </div>
            </form>
            <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button type="button" class="btn-primary" onclick="saveRoute()">Save Route</button>
            </div>
        </div>
    </div>

    <!-- Stop Modal -->
    <div id="stop-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="stop-modal-title">Edit Stop</h3>
                <button class="close-btn" onclick="closeModal('stop-modal')">Ã—</button>
            </div>
            <form id="stop-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-group">
                        <label class="form-label">Stop Number</label>
                        <input type="number" class="form-input" name="stopNumber" min="1" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stop Name *</label>
                        <input type="text" class="form-input" name="name" placeholder="Enter stop name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-textarea" name="description" placeholder="Enter detailed description" required></textarea>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Audio Guide</h3>
                    <div class="form-group">
                        <label class="form-label">Audio File</label>
                        <input type="text" class="form-input" name="audioFile" placeholder="Audio filename" readonly>
                        <div class="file-upload-area" id="stop-audio-upload" onclick="document.getElementById('stop-audio-file').click()">
                            <div class="upload-icon">ðŸŽµ</div>
                            <div class="upload-text">Click to upload audio</div>
                            <div class="upload-subtext">MP3, WAV up to 50MB</div>
                        </div>
                        <input type="file" id="stop-audio-file" accept="audio/*" style="display: none;" onchange="handleStopAudioUpload(event)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Audio Duration</label>
                        <input type="text" class="form-input" name="audioDuration" placeholder="e.g. 2:30">
                    </div>
                </div>
                <div class="form-section">
                    <h3>Stop Image</h3>
                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input type="url" class="form-input" name="imageUrl" placeholder="Enter image URL or upload below">
                        <div class="file-upload-area" id="stop-image-upload" onclick="document.getElementById('stop-image-file').click()">
                            <div class="upload-icon">ðŸ“·</div>
                            <div class="upload-text">Click to upload image</div>
                            <div class="upload-subtext">JPG, PNG up to 10MB</div>
                        </div>
                        <input type="file" id="stop-image-file" accept="image/*" style="display: none;" onchange="handleStopImageUpload(event)">
                    </div>
                    
                    <h3 style="margin-top: 30px;">Location & Trigger Area</h3>
                    <div class="form-group">
                        <label class="form-label">Choose Location on Map</label>
                        <button type="button" class="btn-secondary" onclick="openLocationPicker()" style="width: 100%; margin-bottom: 10px;">
                            Select Location on Map
                        </button>
                        
                        <input type="hidden" name="latitude" id="stop-latitude">
                        <input type="hidden" name="longitude" id="stop-longitude">
                        <input type="hidden" name="radius" id="stop-radius" value="50">
                        
                        <div class="coordinates-display" id="coordinates-display">
                            Click "Select Location on Map" to choose coordinates
                        </div>
                        
                        <div class="map-container" id="stopLocationMap" style="display: none;"></div>
                        
                        <div class="location-controls" id="location-controls" style="display: none;">
                            <div class="radius-control">
                                <label style="font-size: 12px; color: rgba(255,255,255,0.8);">Audio Trigger Radius:</label>
                                <input type="range" class="radius-slider" id="radius-slider" min="10" max="200" value="50" oninput="updateRadius(this.value)">
                                <span id="radius-value" style="font-size: 12px; color: #FFD700; min-width: 40px;">50m</span>
                            </div>
                            <button type="button" class="btn-secondary" onclick="getCurrentLocation()" style="padding: 8px 16px; font-size: 12px;">
                                Use My Location
                            </button>
                        </div>
                    </div>
                </div>
            </form>
            <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button type="button" class="btn-secondary" onclick="closeModal('stop-modal')">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveStop()">Save Stop</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        const API_BASES = ['/api', `${window.location.origin}/api`, 'http://localhost:3001/api'];
        let API_BASE = API_BASES[0];
        let currentRoutes = [];
        let editingRoute = null;
        let editingRouteStops = [];
        let editingStopIndex = -1;
        let availableCities = [];
        let systemStatus = { serverConnected: false, routesLoaded: false };

        // Map variables
        let stopLocationMap = null;
        let routeOverviewMap = null;
        let currentMarker = null;
        let currentCircle = null;
        let routePolyline = null;
        let routeMarkers = [];

        // Initialize CMS
        document.addEventListener('DOMContentLoaded', function() {
            initializeCMS();
            setupTabNavigation();
        });

        async function initializeCMS() {
            await testConnection();
            await loadCities();
            await loadRoutes();
            setupImagePositionPreview();
        }

        async function loadCities() {
            console.log('Loading cities for CMS...');
            
            try {
                const response = await fetch(`${API_BASE}/cities`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                availableCities = await response.json();
                console.log('Loaded cities:', availableCities);
                populateCityDropdown();
                
            } catch (error) {
                console.error('Error loading cities:', error);
                availableCities = [
                    { name: 'Milan', country: 'Italy' },
                    { name: 'Vienna', country: 'Austria' },
                    { name: 'Rome', country: 'Italy' },
                    { name: 'Paris', country: 'France' }
                ];
                populateCityDropdown();
            }
        }

        function populateCityDropdown() {
            const dropdown = document.getElementById('cityDropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">Select a city</option>';
            
            availableCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = city.country ? `${city.name}, ${city.country}` : city.name;
                dropdown.appendChild(option);
            });
            
            console.log(`Added ${availableCities.length} cities to dropdown`);
        }

        function toggleCityInput() {
            const dropdownContainer = document.getElementById('cityDropdownContainer');
            const addCityContainer = document.getElementById('addCityContainer');
            const toggleBtn = document.getElementById('cityToggleBtn');
            
            if (dropdownContainer.style.display === 'none') {
                dropdownContainer.style.display = 'block';
                addCityContainer.style.display = 'none';
                toggleBtn.textContent = '+ Add New';
                document.getElementById('newCityInput').value = '';
            } else {
                dropdownContainer.style.display = 'none';
                addCityContainer.style.display = 'block';
                toggleBtn.textContent = 'Cancel';
                document.getElementById('newCityInput').focus();
            }
        }

        async function addNewCity(cityName) {
            if (!cityName || !cityName.trim()) {
                return null;
            }
            
            const trimmedCity = cityName.trim();
            
            if (availableCities.some(city => city.name.toLowerCase() === trimmedCity.toLowerCase())) {
                console.log('City already exists:', trimmedCity);
                return trimmedCity;
            }
            
            try {
                const response = await fetch(`${API_BASE}/cities`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: trimmedCity })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add city');
                }
                
                const newCity = await response.json();
                console.log('Added new city:', newCity);
                
                availableCities.push(newCity);
                populateCityDropdown();
                showSuccess(`City "${trimmedCity}" added successfully!`);
                return trimmedCity;
                
            } catch (error) {
                console.error('Error adding city:', error);
                showError(`Failed to add city: ${error.message}`);
                return null;
            }
        }

        async function testConnection() {
            console.log('Testing connection to server...');
            
            const serverDot = document.getElementById('server-status');
            const serverText = document.getElementById('server-status-text');
            const routesDot = document.getElementById('routes-status');
            const routesText = document.getElementById('routes-status-text');

            let connected = false;

            for (const baseUrl of API_BASES) {
                try {
                    serverText.textContent = `Testing ${baseUrl}...`;
                    
                    const healthResponse = await fetch(`${baseUrl}/health`, { 
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (healthResponse.ok) {
                        const healthData = await healthResponse.json();
                        API_BASE = baseUrl;
                        connected = true;
                        
                        serverDot.className = 'status-dot green';
                        serverText.textContent = `Server Online (${healthData.routes} routes) - ${baseUrl}`;
                        systemStatus.serverConnected = true;
                        
                        console.log('Server connected via:', baseUrl);
                        break;
                    }
                } catch (error) {
                    console.log(`Failed ${baseUrl}:`, error.message);
                    continue;
                }
            }

            if (!connected) {
                serverDot.className = 'status-dot red';
                serverText.textContent = 'Server Offline - All URLs failed';
                routesDot.className = 'status-dot red';
                routesText.textContent = 'Cannot connect to server';
                systemStatus.serverConnected = false;
                systemStatus.routesLoaded = false;
                showError('Server connection failed. Make sure server is running.');
                return;
            }

            try {
                routesText.textContent = 'Testing routes...';
                const routesResponse = await fetch(`${API_BASE}/routes`);
                
                if (routesResponse.ok) {
                    const routes = await routesResponse.json();
                    routesDot.className = 'status-dot green';
                    routesText.textContent = `Routes API Working (${routes.length} routes)`;
                    systemStatus.routesLoaded = true;
                } else {
                    throw new Error(`Routes API failed: ${routesResponse.status}`);
                }
            } catch (error) {
                console.error('Routes test failed:', error);
                routesDot.className = 'status-dot yellow';
                routesText.textContent = 'Routes API issues';
                systemStatus.routesLoaded = false;
                showError(`Routes API failed: ${error.message}`);
            }
        }

        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabId}-tab`).style.display = 'block';

            switch(tabId) {
                case 'routes':
                    loadRoutes();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function showSuccess(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function clearMessages() {
            document.getElementById('error-container').innerHTML = '';
        }

        async function loadAnalytics() {
            const analyticsContent = document.getElementById('analytics-content');
            analyticsContent.innerHTML = '<div class="loading">Loading analytics...</div>';

            try {
                const response = await fetch(`${API_BASE}/analytics`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const analytics = await response.json();
                console.log('Analytics data:', analytics);

                let cityBreakdownHTML = '';
                if (analytics.cityBreakdown && Object.keys(analytics.cityBreakdown).length > 0) {
                    cityBreakdownHTML = `
                        <div class="form-section" style="margin-top: 20px;">
                            <h3>Routes by City</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${Object.entries(analytics.cityBreakdown).map(([city, stats]) => `
                                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 18px; font-weight: 600; color: #FFD700; margin-bottom: 5px;">${city}</div>
                                        <div style="font-size: 14px; color: rgba(255,255,255,0.8);">
                                            ${stats.total} total (${stats.published} published)
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                analyticsContent.innerHTML = `
                    <div class="form-section">
                        <h3>Route Overview</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 32px; font-weight: 700; color: #FFD700;">${analytics.totalRoutes || 0}</div>
                                <div style="color: rgba(255,255,255,0.8);">Total Routes</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 32px; font-weight: 700; color: #4CAF50;">${analytics.publishedRoutes || 0}</div>
                                <div style="color: rgba(255,255,255,0.8);">Published</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 32px; font-weight: 700; color: #ff6b6b;">${analytics.unpublishedRoutes || 0}</div>
                                <div style="color: rgba(255,255,255,0.8);">Drafts</div>
                            </div>
                        </div>
                    </div>
                    ${cityBreakdownHTML}
                `;

            } catch (error) {
                console.error('Error loading analytics:', error);
                analyticsContent.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading analytics</h3>
                        <p>${error.message}</p>
                        <button class="btn-primary" onclick="loadAnalytics()">Retry</button>
                    </div>
                `;
            }
        }

        async function loadRoutes() {
            const routesList = document.getElementById('routes-list');
            routesList.innerHTML = '<div class="loading">Loading routes...</div>';
            clearMessages();

            if (!systemStatus.serverConnected) {
                showError('Cannot load routes - server connection failed');
                routesList.innerHTML = `
                    <div class="empty-state">
                        <h3>Server Connection Failed</h3>
                        <p>Make sure your server is running and try again.</p>
                        <button class="btn-primary" onclick="testConnection()">Retry Connection</button>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/routes`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                currentRoutes = await response.json();

                if (currentRoutes.length === 0) {
                    routesList.innerHTML = `
                        <div class="empty-state">
                            <h3>No routes found</h3>
                            <p>Create your first audio tour route to get started.</p>
                            <button class="btn-primary" onclick="createNewRoute()">+ Create First Route</button>
                        </div>
                    `;
                    return;
                }

                routesList.innerHTML = currentRoutes.map(route => `
                    <div class="route-card" data-route-id="${route.id}">
                        <div class="route-header">
                            <div>
                                <div class="route-name" onclick="editRoute('${route.id}')">
                                    ${route.name}
                                </div>
                                <div class="route-tags">
                                    <span class="tag ${route.category?.toLowerCase() || 'modern'}">${route.category || 'Modern'}</span>
                                    <span class="tag">${route.city || 'Unknown City'}</span>
                                    <span class="tag ${route.published ? 'published' : 'draft'}">
                                        ${route.published ? 'Published' : 'Draft'}
                                    </span>
                                </div>
                            </div>
                            <div class="route-actions">
                                <div class="publish-toggle-container">
                                    <span class="publish-toggle-label">Publish</span>
                                    <div class="toggle-switch ${route.published ? 'active' : ''}" 
                                         onclick="togglePublish('${route.id}', ${!route.published})">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="toggle-status">${route.published ? 'Live' : 'Draft'}</span>
                                </div>
                                <button class="btn-icon" onclick="editRoute('${route.id}')" title="Edit">Edit</button>
                                <button class="btn-icon btn-delete" onclick="deleteRoute('${route.id}')" title="Delete">Delete</button>
                            </div>
                        </div>
                        <div class="route-description">${route.description || 'No description'}</div>
                        <div class="route-stats">
                            <div class="stat">
                                <div class="stat-label">Total Stops</div>
                                <div class="stat-value">${route.points?.length || 0}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Duration</div>
                                <div class="stat-value">${route.estimatedDuration || 'N/A'}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Distance</div>
                                <div class="stat-value">${route.distance || 'N/A'}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Difficulty</div>
                                <div class="stat-value">${route.difficulty || 'Easy'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                showSuccess(`Loaded ${currentRoutes.length} routes successfully`);

            } catch (error) {
                console.error('Error loading routes:', error);
                showError(`Failed to load routes: ${error.message}`);
            }
        }

        async function togglePublish(routeId, shouldPublish) {
            try {
                const response = await fetch(`${API_BASE}/routes/${routeId}/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ published: shouldPublish })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const result = await response.json();
                
                const routeIndex = currentRoutes.findIndex(r => r.id === routeId);
                if (routeIndex !== -1) {
                    currentRoutes[routeIndex].published = shouldPublish;
                }
                
                showSuccess(`Route ${shouldPublish ? 'published' : 'unpublished'} successfully!`);
                setTimeout(() => loadRoutes(), 1000);
                
            } catch (error) {
                console.error('Error toggling publish status:', error);
                showError(`Failed to ${shouldPublish ? 'publish' : 'unpublish'} route: ${error.message}`);
            }
        }

        function createNewRoute() {
            editingRoute = null;
            editingRouteStops = [];
            document.getElementById('modal-title').textContent = 'Create New Route';
            document.getElementById('route-form').reset();
            document.getElementById('stops-count-display').textContent = '0 stops';
            
            document.getElementById('route-image-preview').innerHTML = '<div class="route-image-placeholder">No image selected</div>';
            hideImagePositionPreview();
            
            document.querySelector('[name="imagePosition"]').value = 'center';
            resetCitySelector();
            updateStopsListInline();
            document.getElementById('route-overview-container').style.display = 'none';
            showModal('route-modal');
        }

        function resetCitySelector() {
            const dropdownContainer = document.getElementById('cityDropdownContainer');
            const addCityContainer = document.getElementById('addCityContainer');
            const toggleBtn = document.getElementById('cityToggleBtn');
            const newCityInput = document.getElementById('newCityInput');
            
            dropdownContainer.style.display = 'block';
            addCityContainer.style.display = 'none';
            toggleBtn.textContent = '+ Add New';
            newCityInput.value = '';
            
            populateCityDropdown();
        }

        function editRoute(routeId) {
            editingRoute = routeId;
            const route = currentRoutes.find(r => r.id === routeId);
            if (!route) {
                showError('Route not found');
                return;
            }

            document.getElementById('modal-title').textContent = `Edit Route: ${route.name}`;
            
            const form = document.getElementById('route-form');
            const fields = ['name', 'category', 'difficulty', 'estimatedDuration', 'distance', 'description', 'color', 'imageUrl', 'imagePosition'];
            
            fields.forEach(field => {
                const input = form.querySelector(`[name="${field}"]`);
                if (input && route[field]) {
                    input.value = route[field];
                }
            });

            resetCitySelector();
            const cityDropdown = document.getElementById('cityDropdown');
            if (cityDropdown && route.city) {
                cityDropdown.value = route.city;
            }

            if (!route.imagePosition) {
                form.querySelector('[name="imagePosition"]').value = 'center';
            }

            const preview = document.getElementById('route-image-preview');
            if (route.imageUrl) {
                preview.innerHTML = `<img src="${route.imageUrl}" alt="Route preview">`;
                showImagePositionPreview(route.imageUrl, route.imagePosition || 'center');
            } else {
                preview.innerHTML = '<div class="route-image-placeholder">No image selected</div>';
                hideImagePositionPreview();
            }

            editingRouteStops = route.points || [];
            document.getElementById('stops-count-display').textContent = `${editingRouteStops.length} stops`;
            updateStopsListInline();
            initializeRouteOverviewMap();
            showModal('route-modal');
        }

        async function saveRoute() {
            const form = document.getElementById('route-form');
            const formData = new FormData(form);
            
            const routeData = {};
            for (let [key, value] of formData.entries()) {
                routeData[key] = value;
            }

            // Handle city selection - check if we're adding a new city
            const dropdownContainer = document.getElementById('cityDropdownContainer');
            const addCityContainer = document.getElementById('addCityContainer');
            
            if (addCityContainer.style.display !== 'none') {
                // Adding new city
                const newCityInput = document.getElementById('newCityInput');
                const newCityName = newCityInput.value.trim();
                
                if (!newCityName) {
                    showError('Please enter a city name or select from existing cities');
                    return;
                }
                
                const addedCity = await addNewCity(newCityName);
                if (!addedCity) {
                    showError('Failed to add new city');
                    return;
                }
                routeData.city = addedCity;
            } else {
                // Using existing city from dropdown
                const cityDropdown = document.getElementById('cityDropdown');
                routeData.city = cityDropdown.value;
            }

            routeData.points = editingRouteStops;

            if (!routeData.name || !routeData.city) {
                showError('Name and City are required fields');
                return;
            }

            try {
                let response;
                if (editingRoute) {
                    response = await fetch(`${API_BASE}/routes/${editingRoute}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(routeData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/routes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(routeData)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                const savedRoute = await response.json();

                closeModal('route-modal');
                showSuccess(`Route "${routeData.name}" saved successfully!`);
                await loadRoutes();

            } catch (error) {
                console.error('Error saving route:', error);
                showError(`Failed to save route: ${error.message}`);
            }
        }

        async function deleteRoute(routeId) {
            const route = currentRoutes.find(r => r.id === routeId);
            if (!confirm(`Are you sure you want to delete "${route?.name || routeId}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/routes/${routeId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }

                showSuccess('Route deleted successfully');
                await loadRoutes();

            } catch (error) {
                console.error('Error deleting route:', error);
                showError(`Failed to delete route: ${error.message}`);
            }
        }

        async function regenerateRoutesFile() {
            try {
                const response = await fetch(`${API_BASE}/regenerate-routes`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                showSuccess(`App updated! ${result.publishedRoutes} published routes are now live in your app.`);
                
            } catch (error) {
                console.error('Error regenerating routes:', error);
                showError(`Failed to update app: ${error.message}`);
            }
        }

        function setupImagePositionPreview() {
            const positionSelect = document.querySelector('[name="imagePosition"]');
            const imageUrlInput = document.querySelector('[name="imageUrl"]');
            
            if (positionSelect) {
                positionSelect.addEventListener('change', function() {
                    const currentImageUrl = imageUrlInput.value;
                    if (currentImageUrl) {
                        showImagePositionPreview(currentImageUrl, this.value);
                    }
                });
            }
            
            if (imageUrlInput) {
                imageUrlInput.addEventListener('input', function() {
                    if (this.value) {
                        const currentPosition = positionSelect.value || 'center';
                        showImagePositionPreview(this.value, currentPosition);
                    } else {
                        hideImagePositionPreview();
                    }
                });
            }
        }

        function showImagePositionPreview(imageUrl, position) {
            const previewContainer = document.getElementById('imagePositionPreview');
            const previewBox = document.getElementById('positionPreviewBox');
            
            if (previewContainer && previewBox && imageUrl) {
                previewBox.style.backgroundImage = `url('${imageUrl}')`;
                previewBox.style.backgroundPosition = position || 'center';
                previewContainer.style.display = 'block';
            }
        }

        function hideImagePositionPreview() {
            const previewContainer = document.getElementById('imagePositionPreview');
            if (previewContainer) {
                previewContainer.style.display = 'none';
            }
        }

        async function handleRouteImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadArea = document.getElementById('route-image-upload');
            const preview = document.getElementById('route-image-preview');
            
            uploadArea.classList.add('uploading');
            uploadArea.querySelector('.upload-text').textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();
                
                document.querySelector('[name="imageUrl"]').value = result.url;
                
                uploadArea.classList.remove('uploading');
                uploadArea.classList.add('has-file');
                uploadArea.querySelector('.upload-text').textContent = result.originalName;
                uploadArea.querySelector('.upload-subtext').textContent = `${(result.size / 1024 / 1024).toFixed(2)} MB`;
                
                preview.innerHTML = `<img src="${result.url}" alt="Route preview">`;
                
                const currentPosition = document.querySelector('[name="imagePosition"]').value || 'center';
                showImagePositionPreview(result.url, currentPosition);
                
                showSuccess('Route image uploaded successfully');
                
            } catch (error) {
                console.error('Upload error:', error);
                showError('Failed to upload route image');
                
                uploadArea.classList.remove('uploading');
                uploadArea.querySelector('.upload-text').textContent = 'Click to upload route image';
            }
        }

        async function handleStopImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadArea = document.getElementById('stop-image-upload');
            uploadArea.classList.add('uploading');
            uploadArea.querySelector('.upload-text').textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();
                
                document.querySelector('[name="imageUrl"]').value = result.url;
                
                uploadArea.classList.remove('uploading');
                uploadArea.classList.add('has-file');
                uploadArea.querySelector('.upload-text').textContent = result.originalName;
                uploadArea.querySelector('.upload-subtext').textContent = `${(result.size / 1024 / 1024).toFixed(2)} MB`;
                
                showSuccess('Stop image uploaded successfully');
                
            } catch (error) {
                console.error('Upload error:', error);
                showError('Failed to upload stop image');
                
                uploadArea.classList.remove('uploading');
                uploadArea.querySelector('.upload-text').textContent = 'Click to upload image';
            }
        }

        async function handleStopAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadArea = document.getElementById('stop-audio-upload');
            uploadArea.classList.add('uploading');
            uploadArea.querySelector('.upload-text').textContent = 'Uploading audio...';

            try {
                const formData = new FormData();
                formData.append('audio', file);

                const response = await fetch(`${API_BASE}/upload/audio`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                const result = await response.json();
                
                document.querySelector('[name="audioFile"]').value = result.filename;
                
                uploadArea.classList.remove('uploading');
                uploadArea.classList.add('has-file');
                uploadArea.querySelector('.upload-text').textContent = result.originalName;
                uploadArea.querySelector('.upload-subtext').textContent = `${(result.size / 1024 / 1024).toFixed(2)} MB`;
                
                showSuccess('Audio file uploaded successfully');
                
            } catch (error) {
                console.error('Upload error:', error);
                showError('Failed to upload audio file');
                
                uploadArea.classList.remove('uploading');
                uploadArea.querySelector('.upload-text').textContent = 'Click to upload audio';
            }
        }

        function updateStopsListInline() {
            const stopsList = document.getElementById('stops-list-inline');
            const stopsCount = document.getElementById('stops-count-display');
            
            stopsCount.textContent = `${editingRouteStops.length} stops`;
            
            if (editingRouteStops.length === 0) {
                stopsList.innerHTML = '<p style="color: rgba(255,255,255,0.6); font-size: 12px; text-align: center; padding: 20px;">No stops added yet</p>';
                return;
            }

            stopsList.innerHTML = editingRouteStops.map((stop, index) => `
                <div class="stop-item" onclick="editStop(${index})">
                    <div class="stop-header">
                        <div>
                            <div class="stop-name">${index + 1}. ${stop.name || 'Unnamed Stop'}</div>
                            <div class="stop-details">
                                ${stop.coordinates ? `${stop.coordinates[1]?.toFixed(4)}, ${stop.coordinates[0]?.toFixed(4)}` : 'No location'}
                                ${stop.radius ? ` â€¢ ${stop.radius}m radius` : ''}
                                ${stop.audioFile ? ' Audio' : ' No Audio'}
                                ${stop.imageUrl ? ' Image' : ''}
                            </div>
                        </div>
                        <button class="stop-delete-btn" onclick="event.stopPropagation(); deleteStop(${index})">Ã—</button>
                    </div>
                </div>
            `).join('');

            if (editingRouteStops.length > 0) {
                initializeRouteOverviewMap();
            }
        }

        function addNewStop() {
            editingStopIndex = -1;
            document.getElementById('stop-modal-title').textContent = `Add Stop ${editingRouteStops.length + 1}`;
            document.getElementById('stop-form').reset();
            document.getElementById('stop-form').querySelector('[name="stopNumber"]').value = editingRouteStops.length + 1;
            
            document.getElementById('stopLocationMap').style.display = 'none';
            document.getElementById('location-controls').style.display = 'none';
            document.getElementById('coordinates-display').innerHTML = 'Click "Select Location on Map" to choose coordinates';
            document.getElementById('stop-radius').value = '50';
            document.getElementById('radius-slider').value = '50';
            document.getElementById('radius-value').textContent = '50m';
            
            resetUploadAreas();
            showModal('stop-modal');
        }

        function editStop(index) {
            editingStopIndex = index;
            const stop = editingRouteStops[index];
            document.getElementById('stop-modal-title').textContent = `Edit Stop ${index + 1}`;
            
            const form = document.getElementById('stop-form');
            form.querySelector('[name="stopNumber"]').value = index + 1;
            form.querySelector('[name="name"]').value = stop.name || '';
            form.querySelector('[name="description"]').value = stop.description || '';
            
            if (stop.coordinates) {
                document.getElementById('stop-latitude').value = stop.coordinates[1];
                document.getElementById('stop-longitude').value = stop.coordinates[0];
                document.getElementById('coordinates-display').innerHTML = 
                    `Selected: ${stop.coordinates[1]?.toFixed(6)}, ${stop.coordinates[0]?.toFixed(6)}`;
            }
            
            const radius = stop.radius || 50;
            document.getElementById('stop-radius').value = radius;
            document.getElementById('radius-slider').value = radius;
            document.getElementById('radius-value').textContent = radius + 'm';
            
            form.querySelector('[name="imageUrl"]').value = stop.imageUrl || '';
            form.querySelector('[name="audioFile"]').value = stop.audioFile || '';
            form.querySelector('[name="audioDuration"]').value = stop.audioDuration || '';
            
            document.getElementById('stopLocationMap').style.display = 'none';
            document.getElementById('location-controls').style.display = 'none';
            
            resetUploadAreas();
            if (stop.audioFile) {
                const audioUpload = document.getElementById('stop-audio-upload');
                audioUpload.classList.add('has-file');
                audioUpload.querySelector('.upload-text').textContent = stop.audioFile;
            }
            if (stop.imageUrl) {
                const imageUpload = document.getElementById('stop-image-upload');
                imageUpload.classList.add('has-file');
                imageUpload.querySelector('.upload-text').textContent = 'Image uploaded';
            }
            
            showModal('stop-modal');
        }

        function saveStop() {
            const form = document.getElementById('stop-form');
            const formData = new FormData(form);
            
            const stopData = {};
            for (let [key, value] of formData.entries()) {
                stopData[key] = value;
            }

            const lat = parseFloat(document.getElementById('stop-latitude').value);
            const lng = parseFloat(document.getElementById('stop-longitude').value);
            const radius = parseFloat(document.getElementById('stop-radius').value) || 50;

            if (!stopData.name || !stopData.description) {
                alert('Stop name and description are required');
                return;
            }

            if (!lat || !lng) {
                alert('Please select a location on the map');
                return;
            }

            const newStop = {
                name: stopData.name,
                description: stopData.description,
                coordinates: [lng, lat],
                radius: radius,
                type: editingStopIndex === 0 ? 'start' : 'waypoint',
                audioFile: stopData.audioFile || null,
                audioDuration: stopData.audioDuration || null,
                imageUrl: stopData.imageUrl || null
            };

            if (editingStopIndex === -1) {
                editingRouteStops.push(newStop);
            } else {
                editingRouteStops[editingStopIndex] = newStop;
            }

            updateStopsListInline();
            closeModal('stop-modal');
        }

        function deleteStop(index) {
            if (confirm(`Delete stop "${editingRouteStops[index].name}"?`)) {
                editingRouteStops.splice(index, 1);
                updateStopsListInline();
            }
        }

        function resetUploadAreas() {
            const areas = ['route-image-upload', 'stop-image-upload', 'stop-audio-upload'];
            areas.forEach(id => {
                const area = document.getElementById(id);
                if (area) {
                    area.classList.remove('has-file', 'uploading');
                    area.querySelector('.upload-text').textContent = area.id.includes('audio') ? 'Click to upload audio' : 'Click to upload image';
                    area.querySelector('.upload-subtext').textContent = area.id.includes('audio') ? 'MP3, WAV up to 50MB' : 'JPG, PNG up to 10MB';
                }
            });
        }

        function openLocationPicker() {
            const mapContainer = document.getElementById('stopLocationMap');
            const controls = document.getElementById('location-controls');
            
            mapContainer.style.display = 'block';
            controls.style.display = 'flex';
            
            if (!stopLocationMap) {
                initializeStopLocationMap();
            }
            
            setTimeout(() => {
                if (stopLocationMap) {
                    stopLocationMap.invalidateSize();
                }
            }, 100);
        }

        function initializeStopLocationMap() {
            const mapElement = document.getElementById('stopLocationMap');
            if (!mapElement) return;
            
            let defaultLat = 45.4642;
            let defaultLng = 9.1900;
            
            const existingLat = document.getElementById('stop-latitude').value;
            const existingLng = document.getElementById('stop-longitude').value;
            
            if (existingLat && existingLng) {
                defaultLat = parseFloat(existingLat);
                defaultLng = parseFloat(existingLng);
            }
            
            stopLocationMap = L.map('stopLocationMap').setView([defaultLat, defaultLng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(stopLocationMap);
            
            stopLocationMap.on('click', function(e) {
                selectLocationOnMap(e.latlng);
            });
            
            if (existingLat && existingLng) {
                selectLocationOnMap(L.latLng(defaultLat, defaultLng));
            }
        }

        function selectLocationOnMap(latlng) {
            if (currentMarker) {
                stopLocationMap.removeLayer(currentMarker);
            }
            if (currentCircle) {
                stopLocationMap.removeLayer(currentCircle);
            }
            
            currentMarker = L.marker([latlng.lat, latlng.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background-color: #FFD700; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
                    iconSize: [26, 26],
                    iconAnchor: [13, 13]
                })
            }).addTo(stopLocationMap);
            
            const radius = parseInt(document.getElementById('radius-slider').value) || 50;
            currentCircle = L.circle([latlng.lat, latlng.lng], {
                color: '#FFD700',
                fillColor: '#FFD700',
                fillOpacity: 0.2,
                radius: radius
            }).addTo(stopLocationMap);
            
            document.getElementById('stop-latitude').value = latlng.lat;
            document.getElementById('stop-longitude').value = latlng.lng;
            document.getElementById('coordinates-display').innerHTML = 
                `Selected: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
        }

        function updateRadius(value) {
            document.getElementById('stop-radius').value = value;
            document.getElementById('radius-value').textContent = value + 'm';
            
            if (currentCircle && stopLocationMap) {
                const center = currentCircle.getLatLng();
                stopLocationMap.removeLayer(currentCircle);
                currentCircle = L.circle([center.lat, center.lng], {
                    color: '#FFD700',
                    fillColor: '#FFD700',
                    fillOpacity: 0.2,
                    radius: parseInt(value)
                }).addTo(stopLocationMap);
            }
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (stopLocationMap) {
                        stopLocationMap.setView([lat, lng], 16);
                        selectLocationOnMap(L.latLng(lat, lng));
                    }
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    alert('Unable to get your location: ' + error.message);
                }
            );
        }

        function initializeRouteOverviewMap() {
            if (editingRouteStops.length === 0) {
                document.getElementById('route-overview-container').style.display = 'none';
                return;
            }
            
            document.getElementById('route-overview-container').style.display = 'block';
            
            setTimeout(() => {
                const mapElement = document.getElementById('routeOverviewMap');
                if (!mapElement) return;
                
                if (routeOverviewMap) {
                    routeOverviewMap.remove();
                    routeOverviewMap = null;
                }
                
                const coordinates = editingRouteStops
                    .filter(stop => stop.coordinates)
                    .map(stop => [stop.coordinates[1], stop.coordinates[0]]);
                
                if (coordinates.length === 0) return;
                
                const bounds = L.latLngBounds(coordinates);
                routeOverviewMap = L.map('routeOverviewMap').fitBounds(bounds, { padding: [20, 20] });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(routeOverviewMap);
                
                routeMarkers = [];
                
                editingRouteStops.forEach((stop, index) => {
                    if (!stop.coordinates) return;
                    
                    const marker = L.marker([stop.coordinates[1], stop.coordinates[0]], {
                        icon: L.divIcon({
                            className: index === 0 ? 'start-marker' : 'stop-marker',
                            html: `<div style="background-color: ${index === 0 ? '#FF5722' : '#4CAF50'}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${index + 1}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(routeOverviewMap);
                    
                    marker.bindPopup(`<strong>${index + 1}. ${stop.name || 'Unnamed Stop'}</strong><br>${stop.description || 'No description'}`);
                    routeMarkers.push(marker);
                });
                
                if (coordinates.length > 1) {
                    if (routePolyline) {
                        routeOverviewMap.removeLayer(routePolyline);
                    }
                    
                    routePolyline = L.polyline(coordinates, {
                        color: '#FFD700',
                        weight: 4,
                        opacity: 0.8
                    }).addTo(routeOverviewMap);
                }
            }, 100);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
            
            if (modalId === 'stop-modal') {
                if (stopLocationMap) {
                    stopLocationMap.remove();
                    stopLocationMap = null;
                }
                currentMarker = null;
                currentCircle = null;
            }
            
            if (modalId === 'route-modal') {
                if (routeOverviewMap) {
                    routeOverviewMap.remove();
                    routeOverviewMap = null;
                }
                routePolyline = null;
                routeMarkers = [];
            }
        }

        function closeCMS() {
            if (confirm('Are you sure you want to close the CMS?')) {
                window.close();
            }
        }

        async function resetDatabase() {
            if (!confirm('Are you sure you want to reset the database? This will delete all routes!')) {
                return;
            }
            showError('Database reset functionality not implemented - for safety reasons');
        }

        async function importDefaultRoutes() {
            showError('Import default routes functionality not implemented');
        }

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (document.getElementById('route-modal').classList.contains('active')) {
                    saveRoute();
                } else if (document.getElementById('stop-modal').classList.contains('active')) {
                    saveStop();
                }
            }
            
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    closeModal(modal.id);
                });
            }
        });

        // Make functions globally accessible
        window.toggleCityInput = toggleCityInput;
        window.addNewCity = addNewCity;
        window.testConnection = testConnection;
        window.loadRoutes = loadRoutes;
        window.createNewRoute = createNewRoute;
        window.editRoute = editRoute;
        window.saveRoute = saveRoute;
        window.deleteRoute = deleteRoute;
        window.togglePublish = togglePublish;
        window.regenerateRoutesFile = regenerateRoutesFile;
        window.addNewStop = addNewStop;
        window.editStop = editStop;
        window.saveStop = saveStop;
        window.deleteStop = deleteStop;
        window.openLocationPicker = openLocationPicker;
        window.updateRadius = updateRadius;
        window.getCurrentLocation = getCurrentLocation;
        window.handleRouteImageUpload = handleRouteImageUpload;
        window.handleStopImageUpload = handleStopImageUpload;
        window.handleStopAudioUpload = handleStopAudioUpload;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.closeCMS = closeCMS;
        window.resetDatabase = resetDatabase;
        window.importDefaultRoutes = importDefaultRoutes;

        console.log('ICHE CMS Loaded Successfully');
        console.log('Available functions:', Object.keys(window).filter(k => k.includes('Route') || k.includes('Stop') || k.includes('City')));
    </script>

</body>
</html>
            